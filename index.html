<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Liquid & Larder - AI Concierge</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&family=Cormorant+Garamond:ital,wght@0,400;0,500;0,600;1,400&display=swap" rel="stylesheet">
    <style>
        /* ===== CSS Variables - Liquid & Larder Brand Colors ===== */
        :root {
            --color-primary: #0F3D3E;
            --color-primary-light: #1A4A4B;
            --color-primary-dark: #0A2E2F;
            --color-accent: #2BAE76;
            --color-accent-light: #3DC78D;
            --color-accent-dim: rgba(43, 174, 118, 0.1);
            --color-bronze: #8B6F47;
            --color-bronze-dim: rgba(139, 111, 71, 0.08);
            --color-cream: #F0E3D0;
            --color-cream-dark: #E2D0B8;
            --color-text-dark: #2D2D2D;
            --color-surface: #FAF7F2;
            --color-surface-elevated: #FAF7F2;
            --color-surface-subtle: #EDE8DF;
            --color-text-primary: #1C1C1C;
            --color-text-secondary: #7A7169;
            --font-primary: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            --font-serif: 'Cormorant Garamond', Georgia, serif;
            --spacing-xs: 4px;
            --spacing-sm: 8px;
            --spacing-md: 16px;
            --spacing-lg: 24px;
            --spacing-xl: 32px;
            --spacing-2xl: 48px;
            --spacing-3xl: 64px;
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 20px;
            --radius-full: 50%;
            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.08);
            --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 8px 32px rgba(0, 0, 0, 0.12);
            --transition-smooth: cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* ===== Reset & Base ===== */
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        html { font-size: 16px; -webkit-text-size-adjust: 100%; scroll-behavior: smooth; }
        body {
            font-family: var(--font-primary);
            background-color: var(--color-surface);
            color: var(--color-text-primary);
            line-height: 1.6;
            min-height: 100vh;
            overflow-x: hidden;
        }
        img { max-width: 100%; height: auto; display: block; }
        button { font-family: inherit; cursor: pointer; border: none; background: none; }
        a { text-decoration: none; color: inherit; }

        /* ===== Animations ===== */
        @keyframes floatIn {
          from { opacity: 0; transform: translateY(20px) scale(0.95); }
          to { opacity: 1; transform: translateY(0) scale(1); }
        }

        /* ===== Widget Styles ===== */
        #concy-widget-root { font-family: var(--font-primary); line-height: 1.5; }
        #concy-widget-root *, #concy-widget-root *::before, #concy-widget-root *::after { box-sizing: border-box; }
        #concy-widget-root img { max-width: 100%; height: auto; display: block; }
        #concy-widget-root button { font-family: inherit; cursor: pointer; border: none; background: none; }
        #concy-widget-root .chatbot-container {
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background: var(--color-surface);
          z-index: 2000;
          display: flex;
          flex-direction: column;
          overflow: hidden;
        }

        /* ===== Background Orbs (for glassmorphism) ===== */

        /* ===== Header ===== */
        #concy-widget-root .chat-header {
          display: flex;
          align-items: center;
          justify-content: space-between;
          padding: var(--spacing-md) var(--spacing-lg);
          background-color: var(--color-surface);
          border-bottom: 1px solid rgba(139, 111, 71, 0.12);
          flex-shrink: 0;
        }
        #concy-widget-root .chat-brand {
          display: flex;
          flex-direction: row;
          align-items: center;
          gap: 8px;
        }
        #concy-widget-root .chat-logo-img {
          height: 28px;
          width: auto;
          object-fit: contain;
          opacity: 0.9;
        }
        #concy-widget-root .chat-brand-name {
          font-family: var(--font-serif);
          font-size: 1.05rem;
          letter-spacing: 0.1em;
          font-weight: 400;
          color: var(--color-text-primary);
        }
        #concy-widget-root .new-chat-btn {
          display: flex;
          align-items: center;
          gap: var(--spacing-xs);
          color: var(--color-text-secondary);
          padding: var(--spacing-xs) var(--spacing-sm);
          border-radius: 6px;
          border: 1px solid rgba(139, 111, 71, 0.2);
          background: transparent;
          font-size: 0.7rem;
          font-weight: 500;
          letter-spacing: 0.05em;
          transition: all 0.2s ease;
        }
        #concy-widget-root .new-chat-btn:hover {
          background-color: rgba(0, 0, 0, 0.05);
          border-color: rgba(0, 0, 0, 0.2);
          color: var(--color-text-primary);
        }
        #concy-widget-root .new-chat-btn svg { width: 16px; height: 16px; }

        /* ===== Welcome Screen ===== */
        #concy-widget-root .welcome-screen {
          display: flex;
          flex-direction: column;
          align-items: center;
          justify-content: center;
          padding: var(--spacing-2xl) var(--spacing-lg) var(--spacing-lg);
          flex: 1;
          overflow-y: auto;
          text-align: center;
        }
        #concy-widget-root .welcome-screen.hidden { display: none; }
        #concy-widget-root .welcome-art {
          margin-bottom: var(--spacing-xl);
        }
        #concy-widget-root .welcome-greeting {
          font-family: var(--font-serif);
          font-size: 2.8rem;
          font-weight: 500;
          color: var(--color-text-primary);
          margin-bottom: var(--spacing-md);
          letter-spacing: -0.02em;
          line-height: 1.1;
        }
        #concy-widget-root .welcome-subtitle {
          font-family: var(--font-serif);
          font-size: 1.05rem;
          font-style: italic;
          font-weight: 400;
          color: var(--color-text-secondary);
          line-height: 1.6;
          margin-bottom: var(--spacing-xl);
          max-width: 320px;
        }
        #concy-widget-root .quick-questions {
          width: 100%;
          max-width: 480px;
          text-align: left;
        }
        #concy-widget-root .quick-questions-label {
          font-family: var(--font-serif);
          font-size: 0.85rem;
          font-style: italic;
          font-weight: 400;
          letter-spacing: 0.06em;
          color: var(--color-bronze);
          opacity: 0.9;
          border-left: 2px solid var(--color-bronze);
          padding-left: var(--spacing-sm);
          margin-bottom: var(--spacing-md);
        }
        #concy-widget-root .quick-questions-list {
          display: flex;
          flex-direction: column;
          gap: 8px;
        }
        #concy-widget-root .quick-question-item {
          display: flex;
          align-items: center;
          justify-content: space-between;
          width: 100%;
          text-align: left;
          padding: 14px var(--spacing-md);
          font-size: 0.875rem;
          color: var(--color-text-primary);
          background: var(--color-surface-elevated);
          border: 1px solid var(--color-surface-subtle);
          border-radius: 12px;
          cursor: pointer;
          transition: all 0.2s ease;
          line-height: 1.5;
          font-family: var(--font-primary);
          box-shadow: 0 1px 4px rgba(0, 0, 0, 0.05);
        }
        #concy-widget-root .quick-question-item::after {
          content: '→';
          opacity: 0;
          transform: translateX(-4px);
          transition: all 0.2s ease;
          color: var(--color-accent);
          font-size: 1rem;
          flex-shrink: 0;
          margin-left: 8px;
        }
        #concy-widget-root .quick-question-item:hover {
          background: var(--color-surface-elevated);
          border-color: rgba(15, 61, 62, 0.2);
          box-shadow: 0 3px 12px rgba(0, 0, 0, 0.09);
          transform: translateY(-1px);
        }
        #concy-widget-root .quick-question-item:hover::after {
          opacity: 0.6;
          transform: translateX(0);
        }

        /* ===== Chat Messages ===== */
        #concy-widget-root .chat-messages {
          flex: 1;
          overflow-y: auto;
          padding: var(--spacing-lg) max(16px, calc(50% - 380px));
          display: flex;
          flex-direction: column;
          gap: 0;
          background-color: var(--color-surface);
        }
        #concy-widget-root .chat-messages.hidden { display: none; }
        #concy-widget-root .message {
          display: flex;
          max-width: 100%;
          margin-bottom: 0;
        }
        #concy-widget-root .bot-message + .bot-message { margin-top: 24px; }
        #concy-widget-root .user-message + .user-message { margin-top: 24px; }
        #concy-widget-root .bot-message + .user-message,
        #concy-widget-root .user-message + .bot-message { margin-top: 32px; }
        #concy-widget-root .bot-message { align-self: flex-start; width: 100%; }
        #concy-widget-root .bot-message .message-content { width: 100%; }
        #concy-widget-root .bot-message .message-bubble { width: 100%; }
        #concy-widget-root .user-message { align-self: flex-end; flex-direction: row-reverse; }
        #concy-widget-root .message-avatar { display: none; }
        #concy-widget-root .message-avatar-spacer { display: none; }
        #concy-widget-root .concy-cat-small { display: none; }
        #concy-widget-root .message-content {
          display: flex;
          flex-direction: column;
          align-items: flex-start;
          width: 100%;
        }
        #concy-widget-root .user-message .message-content { align-items: flex-end; }
        #concy-widget-root .bot-message .message-content { align-items: stretch; }

        /* ===== Message Bubbles ===== */
        #concy-widget-root .message-bubble {
          padding: 14px 16px;
          border-radius: 16px;
          font-size: 16px;
          line-height: 1.65;
          word-break: normal;
          overflow-wrap: break-word;
          -webkit-font-smoothing: antialiased;
          -moz-osx-font-smoothing: grayscale;
          text-rendering: optimizeLegibility;
          letter-spacing: 0em;
          font-weight: 400;
          text-align: left;
        }
        #concy-widget-root .message-bubble p { margin: 0 0 12px 0; line-height: 1.65; }
        #concy-widget-root .message-bubble p:last-child { margin-bottom: 0; }
        #concy-widget-root .message-bubble ul,
        #concy-widget-root .message-bubble ol { margin: 14px 0; padding-left: 24px; list-style-position: outside; }
        #concy-widget-root .message-bubble ul { list-style-type: none; }
        #concy-widget-root .message-bubble ul li { position: relative; padding-left: 8px; }
        #concy-widget-root .message-bubble ul li::before {
          content: "\2022";
          position: absolute;
          left: -14px;
          color: rgba(15, 61, 62, 0.5);
          font-weight: 600;
          font-size: 1.2em;
          line-height: 1.5;
        }
        #concy-widget-root .message-bubble ol { counter-reset: list-counter; }
        #concy-widget-root .message-bubble ol li { counter-increment: list-counter; position: relative; }
        #concy-widget-root .message-bubble ol li::before {
          content: counter(list-counter) ".";
          position: absolute;
          left: -22px;
          color: rgba(15, 61, 62, 0.5);
          font-weight: 500;
          font-size: 0.95em;
        }
        #concy-widget-root .message-bubble li { margin: 10px 0; line-height: 1.6; padding-left: 0; }
        #concy-widget-root .message-bubble strong { font-weight: 600; color: inherit; letter-spacing: -0.008em; }
        #concy-widget-root .message-bubble em { font-style: italic; font-weight: 400; letter-spacing: -0.005em; }
        #concy-widget-root .message-bubble h3 { font-size: 1.05em; margin: 14px 0 8px 0; font-weight: 600; line-height: 1.4; }
        #concy-widget-root .message-bubble h4 { font-size: 1em; margin: 12px 0 6px 0; font-weight: 600; line-height: 1.4; }
        #concy-widget-root .message-bubble h3:first-child,
        #concy-widget-root .message-bubble h4:first-child { margin-top: 0; }
        #concy-widget-root .message-bubble pre {
          overflow-x: auto;
          max-width: 100%;
          font-size: 0.85em;
          padding: 8px 12px;
          background: rgba(0, 0, 0, 0.04);
          border-radius: 6px;
          margin: 8px 0;
        }
        #concy-widget-root .message-bubble code {
          font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
          font-size: 0.9em;
          padding: 2px 6px;
          background: rgba(0, 0, 0, 0.05);
          border-radius: 4px;
          letter-spacing: 0;
        }
        #concy-widget-root .message-bubble pre code {
          padding: 0;
          background: none;
          font-size: inherit;
        }
        #concy-widget-root .message-bubble a:not(.chat-link):not(.suggestion-chip) {
          color: var(--color-primary);
          text-decoration: underline;
          text-decoration-thickness: 1px;
          text-underline-offset: 2px;
          text-decoration-color: rgba(15, 61, 62, 0.35);
          transition: all 0.2s ease;
        }
        #concy-widget-root .message-bubble a:not(.chat-link):not(.suggestion-chip):hover {
          text-decoration-color: rgba(15, 61, 62, 0.8);
        }
        #concy-widget-root .message-iframe {
          display: block;
          width: 100%;
          aspect-ratio: 1 / 1;
          height: auto;
          border: 0;
          border-radius: 16px;
          margin-top: 8px;
        }
        #concy-widget-root .chat-link {
          display: inline;
          background: none;
          color: var(--color-primary);
          padding: 0;
          border-radius: 0;
          text-decoration: underline;
          text-decoration-thickness: 1px;
          text-underline-offset: 2px;
          text-decoration-color: rgba(15, 61, 62, 0.4);
          font-weight: 400;
          font-size: inherit;
          margin-top: 0;
          transition: text-decoration-color 0.15s ease;
          letter-spacing: inherit;
          box-shadow: none;
          word-break: break-all;
        }
        #concy-widget-root .chat-link:hover {
          text-decoration-color: var(--color-primary);
          background: none;
          color: var(--color-primary);
          outline: none;
          transform: none;
          box-shadow: none;
        }

        /* ===== Suggestion Chips ===== */
        #concy-widget-root .suggestion-chips {
          display: flex;
          flex-direction: column;
          gap: 6px;
          margin-top: 10px;
          margin-left: 0;
          margin-right: 0;
          padding-left: 0;
          padding-right: 0;
          width: 100%;
          max-width: 100%;
          align-self: flex-start;
        }

        /* ===== Clarification Options ===== */
        #concy-widget-root .clarification-options {
          display: flex;
          flex-direction: column;
          gap: 8px;
          margin-top: 12px;
        }

        /* ===== Shared: Suggestion Chips + Clarification Options ===== */
        #concy-widget-root .suggestion-chip,
        #concy-widget-root .clarification-option {
          display: block;
          width: 100%;
          padding: 5px 0;
          background-color: transparent;
          color: var(--color-text-secondary);
          border: none;
          border-radius: 8px;
          font-size: 13px;
          font-family: var(--font-primary);
          font-weight: 400;
          text-align: left;
          cursor: pointer;
          transition: background-color 0.15s ease;
          box-shadow: none;
          word-wrap: break-word;
          overflow-wrap: break-word;
          box-sizing: border-box;
          white-space: normal;
          text-decoration: none;
          letter-spacing: 0;
        }
        #concy-widget-root .suggestion-chip:hover,
        #concy-widget-root .suggestion-chip:active,
        #concy-widget-root .clarification-option:hover {
          background-color: transparent;
          color: var(--color-text-primary);
          box-shadow: none;
        }
        #concy-widget-root .clarification-option:disabled {
          opacity: 0.5;
          cursor: not-allowed;
        }

        /* ===== Bot Message Bubble ===== */
        #concy-widget-root .bot-message .message-bubble {
          background: transparent;
          color: var(--color-text-primary);
          border: none;
          border-radius: 0;
          box-shadow: none;
          padding: 2px 0;
          font-size: 15px;
          animation: floatIn 0.25s ease backwards;
        }
        #concy-widget-root .bot-message .message-bubble:hover { box-shadow: none; }

        /* ===== User Message Bubble ===== */
        #concy-widget-root .user-message .message-bubble {
          background: #E8E3DC;
          color: var(--color-text-primary);
          border: none;
          border-radius: 18px;
          box-shadow: none;
          font-size: 0.9375rem;
          transition: none;
          animation: floatIn 0.2s ease backwards;
        }
        #concy-widget-root .user-message .message-bubble:hover { box-shadow: none; }
        /* Disable animation for streaming messages */
        #concy-widget-root .message.streaming .message-bubble { animation: none !important; }
        /* Suppress floatIn re-trigger for streamed completions */
        #concy-widget-root .message.finalized .message-bubble { animation: none !important; transition: box-shadow 0.2s ease; }

        /* ===== Message Actions ===== */
        #concy-widget-root .message-actions {
          display: flex;
          gap: 2px;
          margin-top: 6px;
          padding-left: 4px;
          justify-content: flex-end;
        }
        #concy-widget-root .message-action-btn {
          background: none;
          border: none;
          padding: 4px 6px;
          cursor: pointer;
          color: var(--color-text-secondary);
          opacity: 0.4;
          transition: opacity 0.15s ease, color 0.15s ease;
          display: flex;
          align-items: center;
        }
        #concy-widget-root .message-action-btn:hover {
          opacity: 0.75;
        }
        #concy-widget-root .message-action-btn.active {
          opacity: 1;
          color: var(--color-text-primary);
        }
        #concy-widget-root .message-action-btn svg {
          width: 15px;
          height: 15px;
        }
        #concy-widget-root .message-action-btn.copied {
          opacity: 1;
          color: var(--color-primary);
        }

        #concy-widget-root .message-time { font-size: 0.7rem; color: var(--color-text-secondary); opacity: 0.75; margin-top: var(--spacing-xs); padding: 0 var(--spacing-xs); }
        #concy-widget-root .time-slots, #concy-widget-root .restaurant-options { display: flex; flex-wrap: wrap; gap: var(--spacing-sm); margin-top: var(--spacing-sm); }
        #concy-widget-root .time-slot, #concy-widget-root .restaurant-option { padding: var(--spacing-xs) var(--spacing-md); background-color: var(--color-primary); color: var(--color-surface-elevated); border-radius: 0; font-size: 0.8rem; font-weight: 500; transition: all 0.2s ease; }
        #concy-widget-root .time-slot:hover, #concy-widget-root .restaurant-option:hover { opacity: 0.85; transform: scale(1.02); }

        /* ===== Input Area ===== */
        #concy-widget-root .chat-input-container {
          padding: 12px max(var(--spacing-md), calc(50% - 380px)) 16px;
          background-color: var(--color-surface);
          border-top: none;
          flex-shrink: 0;
          position: sticky;
          bottom: 0;
          z-index: 10;
        }
        #concy-widget-root .chat-input-inner {
          position: relative;
          display: flex;
          align-items: center;
        }
        #concy-widget-root .chat-input {
          flex: 1;
          padding: 14px 52px 14px 20px;
          background: #FFFFFF;
          border: none;
          border-radius: 28px;
          color: var(--color-text-primary);
          font-size: 0.95rem;
          outline: none;
          box-shadow: 0 2px 4px rgba(0, 0, 0, 0.04);
          width: 100%;
        }
        #concy-widget-root .chat-input::placeholder {
          color: #AAAAAA;
          font-size: 0.82rem;
          opacity: 1;
        }
        #concy-widget-root .chat-input:focus {
          box-shadow: 0 2px 4px rgba(0, 0, 0, 0.04);
          background: #FFFFFF;
        }
        #concy-widget-root .thinking-toggle {
          position: relative;
          display: inline-flex;
          align-items: center;
          gap: 8px;
          cursor: pointer;
          user-select: none;
        }
        #concy-widget-root .thinking-toggle input[type="checkbox"] { position: absolute; opacity: 0; width: 0; height: 0; }
        #concy-widget-root .thinking-toggle .toggle-slider {
          position: relative;
          width: 40px;
          height: 22px;
          background-color: rgba(0, 0, 0, 0.15);
          border-radius: 11px;
          transition: all 0.3s ease;
          border: 1px solid rgba(0, 0, 0, 0.2);
        }
        #concy-widget-root .thinking-toggle .toggle-slider::before {
          content: '';
          position: absolute;
          width: 16px;
          height: 16px;
          left: 3px;
          top: 2px;
          background-color: var(--color-surface-elevated);
          border-radius: 50%;
          transition: all 0.3s ease;
          box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        #concy-widget-root .thinking-toggle input[type="checkbox"]:checked + .toggle-slider {
          background-color: var(--color-primary);
          border-color: var(--color-primary);
        }
        #concy-widget-root .thinking-toggle input[type="checkbox"]:checked + .toggle-slider::before {
          transform: translateX(18px);
          background-color: var(--color-surface-elevated);
        }

        /* ===== Send Button ===== */
        #concy-widget-root .send-btn {
          position: absolute;
          right: 6px;
          top: 50%;
          transform: translateY(-50%);
          width: 34px;
          height: 34px;
          background: #3C3C3C;
          color: #FFFFFF;
          border-radius: 50%;
          border: none;
          cursor: pointer;
          display: flex;
          align-items: center;
          justify-content: center;
          transition: background 0.2s ease, transform 0.15s ease;
          box-shadow: none;
          flex-shrink: 0;
        }
        #concy-widget-root .send-btn:hover {
          background: #2A2A2A;
          transform: translateY(-50%) scale(1.05);
        }
        #concy-widget-root .send-btn:active {
          transform: translateY(-50%) scale(0.95);
        }

        /* ===== Footer ===== */
        #concy-widget-root .powered-by {
          text-align: center;
          padding: 6px var(--spacing-sm);
          font-family: var(--font-serif);
          font-style: italic;
          font-size: 0.7rem;
          color: var(--color-text-secondary);
          opacity: 0.5;
          background-color: var(--color-surface);
          letter-spacing: 0.04em;
        }

        /* ===== Typing Indicator ===== */
        #concy-widget-root .typing-indicator {
          display: flex;
          gap: 4px;
          padding: var(--spacing-sm) var(--spacing-md);
          background-color: transparent;
          border: none;
          border-radius: 0;
          width: fit-content;
        }
        #concy-widget-root .typing-label {
          font-family: var(--font-serif);
          font-size: 0.8rem;
          font-style: italic;
          color: var(--color-text-secondary);
          opacity: 0.7;
          margin-top: 4px;
          padding: 0 var(--spacing-xs);
        }
        #concy-widget-root .typing-indicator span {
          width: 8px; height: 8px;
          background-color: var(--color-text-secondary);
          border-radius: var(--radius-full);
          opacity: 0.4;
          animation: typing 1.4s ease-in-out infinite;
        }
        #concy-widget-root .typing-indicator span:nth-child(1) { animation-delay: 0s; }
        #concy-widget-root .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        #concy-widget-root .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typing { 0%, 100% { opacity: 0.4; transform: scale(1); } 50% { opacity: 1; transform: scale(1.2); } }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }
        @keyframes slideIn {
          from { opacity: 0; transform: translateY(8px); }
          to { opacity: 1; transform: translateY(0); }
        }

        /* ===== Scrollbar ===== */
        #concy-widget-root .chat-messages::-webkit-scrollbar { width: 4px; }
        #concy-widget-root .chat-messages::-webkit-scrollbar-track { background: transparent; }
        #concy-widget-root .chat-messages::-webkit-scrollbar-thumb { background-color: rgba(15, 61, 62, 0.15); border-radius: 4px; }

        /* ===== Mobile ===== */
        @media (max-width: 767px) {
            #concy-widget-root .chat-messages {
              padding: var(--spacing-md) 20px 80px !important;
            }
            #concy-widget-root .message {
              max-width: 100% !important;
            }
            #concy-widget-root .bot-message {
              width: 100% !important;
              padding: 0 !important;
            }
            #concy-widget-root .user-message {
              max-width: 75% !important;
              align-self: flex-end !important;
            }
            #concy-widget-root .message-avatar { display: none !important; }
            #concy-widget-root .message-avatar-spacer { display: none !important; }
            #concy-widget-root .message-bubble {
              padding: 12px 14px !important;
              font-size: 15px !important;
              line-height: 1.6 !important;
            }
            #concy-widget-root .message-bubble p {
              margin: 0 0 10px 0 !important;
            }
            #concy-widget-root .message-bubble ul,
            #concy-widget-root .message-bubble ol {
              margin: 10px 0 !important;
              padding-left: 20px !important;
            }
            #concy-widget-root .message-bubble li {
              line-height: 1.55 !important;
              margin: 6px 0 !important;
            }
            #concy-widget-root .message-actions {
              gap: 0 !important;
              margin-top: 4px !important;
            }
            #concy-widget-root .message-action-btn {
              padding: 6px 8px !important;
            }
            #concy-widget-root .message-action-btn svg {
              width: 14px !important;
              height: 14px !important;
            }
            #concy-widget-root .bot-message + .bot-message {
              margin-top: 18px !important;
            }
            #concy-widget-root .user-message + .user-message {
              margin-top: 18px !important;
            }
            #concy-widget-root .bot-message + .user-message,
            #concy-widget-root .user-message + .bot-message {
              margin-top: 24px !important;
            }
            #concy-widget-root .message-iframe {
              height: auto !important;
            }
            #concy-widget-root .chat-link {
              padding: 8px 14px !important;
              font-size: 0.85rem !important;
              width: 100% !important;
              text-align: center !important;
            }
            #concy-widget-root .chat-input-container {
              padding: var(--spacing-sm) 14px !important;
            }
            #concy-widget-root .chat-input {
              padding: 11px 52px 11px 16px !important;
              font-size: 16px !important;
            }
            #concy-widget-root .welcome-greeting {
              font-size: 2.2rem;
            }
            #concy-widget-root .suggestion-chip {
              font-size: 13px !important;
              padding: 8px 14px !important;
            }
        }

        /* ===== Desktop ===== */
        @media (min-width: 768px) {
            #concy-widget-root .message {
              max-width: 72%;
            }
            #concy-widget-root .bot-message {
              width: 100%;
              max-width: 100%;
            }
            #concy-widget-root .message-bubble {
              padding: 14px 16px;
              font-size: 15.5px;
              line-height: 1.75;
              letter-spacing: 0em;
            }
            #concy-widget-root .bot-message .message-bubble {
              font-size: 15.5px;
            }
            #concy-widget-root .user-message .message-bubble {
              font-size: 15.5px;
            }
            #concy-widget-root .message-bubble p {
              margin: 0 0 14px 0;
            }
            #concy-widget-root .message-bubble ul,
            #concy-widget-root .message-bubble ol {
              padding-left: 24px;
              margin: 14px 0;
            }
            #concy-widget-root .message-bubble li {
              line-height: 1.75;
            }
            #concy-widget-root .suggestion-chip {
              font-size: 14px;
              border-radius: 8px;
            }
        }
    </style>
</head>
<body>
    <!-- CONCY CHAT WIDGET -->
    <div id="concy-widget-root">
        <div class="chatbot-container active" id="chatbotContainer">
            <div class="chat-header">
                <div class="chat-brand">
                    <img src="./assets/ll-logo.png" alt="LL" class="chat-logo-img">
                    <span class="chat-brand-name">LIQUID & LARDER</span>
                </div>
                <button class="new-chat-btn" id="newChatBtn" aria-label="New chat">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 5v14M5 12h14"/>
                    </svg>
                    <span>New</span>
                </button>
            </div>

            <!-- Welcome Screen -->
            <div id="welcomeScreen" class="welcome-screen">
                <div class="welcome-art">
                    <svg width="200" height="200" viewBox="0 0 200 200" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <defs>
                        <mask id="c-mask-welcome">
                          <circle cx="100" cy="100" r="75" fill="white"/>
                          <circle cx="100" cy="100" r="45" fill="black"/>
                          <rect x="100" y="75" width="80" height="50" fill="black"/>
                        </mask>
                        <path id="lens-welcome" d="M-60,0 C-40,-1.7 -20,-10.1 0,-10.1 C20,-10.1 40,-1.7 60,0 C40,1.7 20,10.1 0,10.1 C-20,10.1 -40,1.7 -60,0 Z" fill="#0F3D3E"/>
                      </defs>
                      <g mask="url(#c-mask-welcome)">
                        <line x1="0" y1="35" x2="200" y2="35" stroke="#0F3D3E" stroke-width="3.4" stroke-linecap="round"/>
                        <use href="#lens-welcome"><animateTransform attributeName="transform" type="translate" values="-12,35; 212,35; -12,35" keyTimes="0;0.5;1" keySplines="0.4 0 0.6 1; 0.4 0 0.6 1" calcMode="spline" dur="4s" repeatCount="indefinite" begin="0s"/></use>
                        <line x1="0" y1="55" x2="200" y2="55" stroke="#0F3D3E" stroke-width="3.4" stroke-linecap="round"/>
                        <use href="#lens-welcome"><animateTransform attributeName="transform" type="translate" values="-12,55; 212,55; -12,55" keyTimes="0;0.5;1" keySplines="0.4 0 0.6 1; 0.4 0 0.6 1" calcMode="spline" dur="4s" repeatCount="indefinite" begin="0.15s"/></use>
                        <line x1="0" y1="75" x2="200" y2="75" stroke="#0F3D3E" stroke-width="3.4" stroke-linecap="round"/>
                        <use href="#lens-welcome"><animateTransform attributeName="transform" type="translate" values="-12,75; 212,75; -12,75" keyTimes="0;0.5;1" keySplines="0.4 0 0.6 1; 0.4 0 0.6 1" calcMode="spline" dur="4s" repeatCount="indefinite" begin="0.3s"/></use>
                        <line x1="0" y1="95" x2="200" y2="95" stroke="#0F3D3E" stroke-width="3.4" stroke-linecap="round"/>
                        <use href="#lens-welcome"><animateTransform attributeName="transform" type="translate" values="-12,95; 212,95; -12,95" keyTimes="0;0.5;1" keySplines="0.4 0 0.6 1; 0.4 0 0.6 1" calcMode="spline" dur="4s" repeatCount="indefinite" begin="0.4s"/></use>
                        <line x1="0" y1="115" x2="200" y2="115" stroke="#0F3D3E" stroke-width="3.4" stroke-linecap="round"/>
                        <use href="#lens-welcome"><animateTransform attributeName="transform" type="translate" values="-12,115; 212,115; -12,115" keyTimes="0;0.5;1" keySplines="0.4 0 0.6 1; 0.4 0 0.6 1" calcMode="spline" dur="4s" repeatCount="indefinite" begin="0.4s"/></use>
                        <line x1="0" y1="135" x2="200" y2="135" stroke="#0F3D3E" stroke-width="3.4" stroke-linecap="round"/>
                        <use href="#lens-welcome"><animateTransform attributeName="transform" type="translate" values="-12,135; 212,135; -12,135" keyTimes="0;0.5;1" keySplines="0.4 0 0.6 1; 0.4 0 0.6 1" calcMode="spline" dur="4s" repeatCount="indefinite" begin="0.3s"/></use>
                        <line x1="0" y1="155" x2="200" y2="155" stroke="#0F3D3E" stroke-width="3.4" stroke-linecap="round"/>
                        <use href="#lens-welcome"><animateTransform attributeName="transform" type="translate" values="-12,155; 212,155; -12,155" keyTimes="0;0.5;1" keySplines="0.4 0 0.6 1; 0.4 0 0.6 1" calcMode="spline" dur="4s" repeatCount="indefinite" begin="0.15s"/></use>
                        <line x1="0" y1="175" x2="200" y2="175" stroke="#0F3D3E" stroke-width="3.4" stroke-linecap="round"/>
                        <use href="#lens-welcome"><animateTransform attributeName="transform" type="translate" values="-12,175; 212,175; -12,175" keyTimes="0;0.5;1" keySplines="0.4 0 0.6 1; 0.4 0 0.6 1" calcMode="spline" dur="4s" repeatCount="indefinite" begin="0s"/></use>
                      </g>
                    </svg>
                </div>
                <h1 class="welcome-greeting" id="welcomeGreeting">Good Evening</h1>
                <p class="welcome-subtitle">I am Liquid and Larder's concierge,<br>how can I help you today?</p>

                <div class="quick-questions">
                    <div class="quick-questions-label">Quick questions</div>
                    <div class="quick-questions-list">
                        <button class="quick-question-item" data-question="I am looking to book a dinner tonight, can you help me?">
                            I am looking to book a dinner tonight, can you help me?
                        </button>
                        <button class="quick-question-item" data-question="What establishments are in the Liquid &amp; Larder group?">
                            What establishments are in the Liquid &amp; Larder group?
                        </button>
                        <button class="quick-question-item" data-question="Which establishments are most suitable for larger groups?">
                            Which establishments are most suitable for larger groups?
                        </button>
                        <button class="quick-question-item" data-question="I have a question about a menu">
                            I have a question about a menu
                        </button>
                    </div>
                </div>
            </div>

            <!-- Chat Messages (hidden initially, shown when conversation starts) -->
            <div class="chat-messages hidden" id="chatMessages"></div>

            <div class="chat-input-container">
                <div class="chat-input-inner">
                    <input type="text" class="chat-input" id="chatInput" placeholder="Ask a question, I am here to help...">
                    <label class="thinking-toggle" title="Deep Search Mode" style="display:none;">
                        <input type="checkbox" id="thinkingToggle">
                        <span class="toggle-slider"></span>
                    </label>
                    <button class="send-btn" id="sendBtn" aria-label="Send message">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" style="transform: rotate(-45deg) translate(1px, -1px); transform-origin: center;">
                            <path d="M3.478 2.405a.75.75 0 0 0-.926.94l2.432 7.905H13.5a.75.75 0 0 1 0 1.5H4.984l-2.432 7.905a.75.75 0 0 0 .926.94 60.519 60.519 0 0 0 18.445-8.986.75.75 0 0 0 0-1.218A60.517 60.517 0 0 0 3.478 2.405Z"/>
                        </svg>
                    </button>
                </div>
            </div>

            <div class="powered-by">Powered by Concy AI</div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
// ── marked.js configuration ──────────────────────────────────────
(function() {
  const renderer = new marked.Renderer();

  // Links: query: protocol → plain text (suggestion chips), others → chat-link button
  renderer.link = ({ href, text }) =>
    href.startsWith('query:') ? text
    : `<a href="${href}" target="_blank" rel="noopener noreferrer" class="chat-link">${text}</a>`;

  // Images: disabled (prevent LLM from injecting arbitrary images)
  renderer.image = ({ text }) => text || '';

  // Headings: cap at h3 minimum (h1/h2 too large for chat bubbles)
  renderer.heading = ({ text, depth }) => {
    const level = Math.max(depth, 3);
    return `<h${level}>${text}</h${level}>`;
  };

  marked.use({ renderer, breaks: true, gfm: true });
})();

// Animated Concy Logo SVG - generates unique IDs to avoid conflicts
let logoCounter = 0;
function getConcyLogoSVG() {
  const id = logoCounter++;
  return `<div class="concy-logo-small"><svg width="200" height="200" viewBox="0 0 200 200" fill="none" xmlns="http://www.w3.org/2000/svg">
    <defs>
      <mask id="c-mask-msg-${id}">
        <circle cx="100" cy="100" r="75" fill="white"/>
        <circle cx="100" cy="100" r="45" fill="black"/>
        <rect x="100" y="75" width="80" height="50" fill="black"/>
      </mask>
      <path id="lens-msg-${id}" d="M-60,0 C-40,-1.7 -20,-10.1 0,-10.1 C20,-10.1 40,-1.7 60,0 C40,1.7 20,10.1 0,10.1 C-20,10.1 -40,1.7 -60,0 Z" fill="#0F3D3E"/>
    </defs>
    <g mask="url(#c-mask-msg-${id})">
      <line x1="0" y1="35" x2="200" y2="35" stroke="#0F3D3E" stroke-width="3.4" stroke-linecap="round"/>
      <use href="#lens-msg-${id}"><animateTransform attributeName="transform" type="translate" values="-12,35; 212,35; -12,35" keyTimes="0;0.5;1" keySplines="0.4 0 0.6 1; 0.4 0 0.6 1" calcMode="spline" dur="4s" repeatCount="indefinite" begin="0s"/></use>
      <line x1="0" y1="55" x2="200" y2="55" stroke="#0F3D3E" stroke-width="3.4" stroke-linecap="round"/>
      <use href="#lens-msg-${id}"><animateTransform attributeName="transform" type="translate" values="-12,55; 212,55; -12,55" keyTimes="0;0.5;1" keySplines="0.4 0 0.6 1; 0.4 0 0.6 1" calcMode="spline" dur="4s" repeatCount="indefinite" begin="0.15s"/></use>
      <line x1="0" y1="75" x2="200" y2="75" stroke="#0F3D3E" stroke-width="3.4" stroke-linecap="round"/>
      <use href="#lens-msg-${id}"><animateTransform attributeName="transform" type="translate" values="-12,75; 212,75; -12,75" keyTimes="0;0.5;1" keySplines="0.4 0 0.6 1; 0.4 0 0.6 1" calcMode="spline" dur="4s" repeatCount="indefinite" begin="0.3s"/></use>
      <line x1="0" y1="95" x2="200" y2="95" stroke="#0F3D3E" stroke-width="3.4" stroke-linecap="round"/>
      <use href="#lens-msg-${id}"><animateTransform attributeName="transform" type="translate" values="-12,95; 212,95; -12,95" keyTimes="0;0.5;1" keySplines="0.4 0 0.6 1; 0.4 0 0.6 1" calcMode="spline" dur="4s" repeatCount="indefinite" begin="0.4s"/></use>
      <line x1="0" y1="115" x2="200" y2="115" stroke="#0F3D3E" stroke-width="3.4" stroke-linecap="round"/>
      <use href="#lens-msg-${id}"><animateTransform attributeName="transform" type="translate" values="-12,115; 212,115; -12,115" keyTimes="0;0.5;1" keySplines="0.4 0 0.6 1; 0.4 0 0.6 1" calcMode="spline" dur="4s" repeatCount="indefinite" begin="0.4s"/></use>
      <line x1="0" y1="135" x2="200" y2="135" stroke="#0F3D3E" stroke-width="3.4" stroke-linecap="round"/>
      <use href="#lens-msg-${id}"><animateTransform attributeName="transform" type="translate" values="-12,135; 212,135; -12,135" keyTimes="0;0.5;1" keySplines="0.4 0 0.6 1; 0.4 0 0.6 1" calcMode="spline" dur="4s" repeatCount="indefinite" begin="0.3s"/></use>
      <line x1="0" y1="155" x2="200" y2="155" stroke="#0F3D3E" stroke-width="3.4" stroke-linecap="round"/>
      <use href="#lens-msg-${id}"><animateTransform attributeName="transform" type="translate" values="-12,155; 212,155; -12,155" keyTimes="0;0.5;1" keySplines="0.4 0 0.6 1; 0.4 0 0.6 1" calcMode="spline" dur="4s" repeatCount="indefinite" begin="0.15s"/></use>
      <line x1="0" y1="175" x2="200" y2="175" stroke="#0F3D3E" stroke-width="3.4" stroke-linecap="round"/>
      <use href="#lens-msg-${id}"><animateTransform attributeName="transform" type="translate" values="-12,175; 212,175; -12,175" keyTimes="0;0.5;1" keySplines="0.4 0 0.6 1; 0.4 0 0.6 1" calcMode="spline" dur="4s" repeatCount="indefinite" begin="0s"/></use>
    </g>
  </svg></div>`;
}

// CONCY CONFIG
const CONCY_CONFIG = {
  api: { backendUrl: 'http://104.225.141.38:8083', endpoints: { chat: '/chat', resetSession: '/chat/reset' } },
  branding: { name: 'Liquid & Larder', shortName: 'LL', botName: 'Concy', getLogo: getConcyLogoSVG },
  messages: { welcome: null, placeholder: "Ask a question, I am here to help...", errorConnection: "I'm having trouble connecting. Please try again in a moment.", errorGeneric: "I'm sorry, I encountered an error. Please try again.", poweredBy: "Powered by Concy AI" },
  widget: { showHookBubble: false, hookDelay: 1500, autoHideHook: false },
  session: { storageKey: 'concy_session', persistHistory: false }
};

// CONCY API
class ConcyAPI {
  constructor(config) {
    this.config = config;
    const isLocalDev = window.location.protocol === 'file:' ||
                      window.location.hostname === 'localhost' ||
                      window.location.hostname === '127.0.0.1' ||
                      window.location.hostname === '';
    this.baseUrl = isLocalDev ? `${config.api.backendUrl}/api/v1` : '/api/v1';
  }
  async sendMessage(message, sessionId, shouldThink, onChunk, onComplete, onClarification) {
    try {
      const response = await fetch(`${this.baseUrl}${this.config.api.endpoints.chat}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ question: message, session_id: sessionId, user_id: null, should_think: shouldThink })
      });

      if (!response.ok) throw new Error('API request failed');

      const reader = response.body.getReader();
      const decoder = new TextDecoder();
      let buffer = '';
      let fullResponse = '';
      let cleanedFullText = null; // full_text from backend's message_complete
      let currentEvent = null;
      let clarificationData = null; // set if clarification event received

      while (true) {
        const { done, value } = await reader.read();
        if (done) break;

        buffer += decoder.decode(value, { stream: true });
        const lines = buffer.split('\n');
        buffer = lines.pop();

        for (const line of lines) {
          if (line.startsWith('event: ')) {
            currentEvent = line.slice(7).trim();
          } else if (line.startsWith('data: ')) {
            try {
              const data = JSON.parse(line.slice(6));

              if (currentEvent === 'message_chunk' && data?.content) {
                fullResponse += data.content;
                if (onChunk) onChunk(data.content);
              } else if (currentEvent === 'message_complete') {
                // Use full_text directly — marked.js handles all formatting
                cleanedFullText = data?.full_text || fullResponse;
              } else if (currentEvent === 'clarification' && data?.questions) {
                clarificationData = data.questions;
              } else if (currentEvent === 'suggestions' && data?.suggestions && Array.isArray(data.suggestions)) {
                if (onComplete) onComplete(cleanedFullText || fullResponse, data.suggestions);
                return { response: cleanedFullText || fullResponse, suggestions: data.suggestions };
              } else if (currentEvent === 'error') {
                throw new Error(data?.message || 'Stream error');
              } else if (currentEvent === 'done') {
                if (clarificationData) {
                  if (onClarification) onClarification(clarificationData);
                  return { clarification: clarificationData };
                }
                const finalText = cleanedFullText || fullResponse;
                if (onComplete) onComplete(finalText, []);
                return { response: finalText || 'Response received' };
              }

              currentEvent = null;
            } catch (e) {
              console.warn('Failed to parse SSE data:', line, e);
            }
          }
        }
      }

      // Ensure onComplete is always called if stream ended without explicit 'done' event
      if (!clarificationData && onComplete) {
        onComplete(cleanedFullText || fullResponse, []);
      }
      return { response: cleanedFullText || fullResponse || 'Response received' };

    } catch (error) {
      console.error('API Error:', error);
      throw error;
    }
  }
  async resetSession(sessionId) {
    if (!sessionId) return;
    try { await fetch(`${this.baseUrl}${this.config.api.endpoints.resetSession}?session_id=${sessionId}`, { method: 'POST' }); }
    catch (e) { /* Session reset failed silently */ }
  }
}

// CONCY WIDGET
class ConcyWidget {
  constructor(config = CONCY_CONFIG) {
    this.config = config;
    this.api = new ConcyAPI(config);
    this.sessionId = null;
    this.isSending = false;  // Prevent concurrent requests
    this.elements = {
      container: document.getElementById('chatbotContainer'),
      input: document.getElementById('chatInput'),
      sendBtn: document.getElementById('sendBtn'),
      messages: document.getElementById('chatMessages'),
      newChatBtn: document.getElementById('newChatBtn'),
      thinkingToggle: document.getElementById('thinkingToggle'),
      welcomeScreen: document.getElementById('welcomeScreen'),
      welcomeGreeting: document.getElementById('welcomeGreeting')
    };
    this.init();
  }
  getTimeBasedGreeting() {
    const hour = new Date().getHours();
    if (hour >= 5 && hour < 12) return 'Good Morning';
    if (hour >= 12 && hour < 17) return 'Good Afternoon';
    return 'Good Evening';
  }
  async init() {
    this.bindEvents();
    this.startNewSession();
    document.body.style.overflow = 'hidden';
    setTimeout(() => { this.elements.input.focus(); }, 300);
  }
  bindEvents() {
    this.elements.newChatBtn.addEventListener('click', () => this.handleNewChat());
    this.elements.sendBtn.addEventListener('click', () => this.sendMessage());
    this.elements.input.addEventListener('keypress', (e) => { if (e.key === 'Enter') this.sendMessage(); });
    this.elements.messages.addEventListener('click', (e) => this.handleOptionClick(e));
    // Quick question click handler
    document.addEventListener('click', (e) => {
      if (e.target.classList.contains('quick-question-item')) {
        this.handleQuickQuestion(e.target);
      }
    });
  }
  startNewSession() {
    this.sessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substring(2, 11);
    this.elements.messages.innerHTML = '';
    // Show welcome screen, hide chat messages
    if (this.elements.welcomeScreen) this.elements.welcomeScreen.classList.remove('hidden');
    if (this.elements.messages) this.elements.messages.classList.add('hidden');
    if (this.elements.welcomeGreeting) this.elements.welcomeGreeting.textContent = this.getTimeBasedGreeting();
  }
  async handleNewChat() {
    await this.api.resetSession(this.sessionId);
    this.startNewSession();
    this.elements.input.focus();
  }
  async handleQuickQuestion(btn) {
    const question = btn.dataset.question;
    if (!question) return;
    // Hide welcome, show chat
    if (this.elements.welcomeScreen) this.elements.welcomeScreen.classList.add('hidden');
    if (this.elements.messages) this.elements.messages.classList.remove('hidden');
    this.addMessage(question, 'user');
    await this.sendMessageToBackend(question);
  }
  async sendMessage() {
    const message = this.elements.input.value.trim();
    if (!message) return;
    // Hide welcome, show chat
    if (this.elements.welcomeScreen) this.elements.welcomeScreen.classList.add('hidden');
    if (this.elements.messages) this.elements.messages.classList.remove('hidden');
    this.addMessage(message, 'user');
    this.elements.input.value = '';
    await this.sendMessageToBackend(message);
  }
  async sendMessageToBackend(message, fallbackResponse = null) {
    // Prevent concurrent requests
    if (this.isSending) {
      console.warn('[Widget] Message already being sent, ignoring duplicate request');
      return;
    }
    this.isSending = true;
    this.showTypingIndicator();
    try {
        let streamingMessageDiv = null;
        let streamingBubble = null;
        let fullText = '';
        let responseFinalized = false;

        const onChunk = (chunk) => {
          this.hideTypingIndicator();
          fullText += chunk;

          // Single streaming bubble
          let streamingDiv = this.elements.messages.querySelector('.message.streaming');
          if (!streamingDiv) {
            streamingDiv = document.createElement('div');
            streamingDiv.className = 'message bot-message streaming';
            this.elements.messages.appendChild(streamingDiv);
          }
          streamingDiv.innerHTML = `
            <div class="message-content">
              <div class="message-bubble">${this.formatMessageText(fullText)}</div>
            </div>`;
          this.scrollToBottom();
        };

        const onComplete = (completedText, suggestions = []) => {
          if (responseFinalized) return;
          responseFinalized = true;

          const timeStr = new Date().toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });

          // Remove streaming bubble
          this.elements.messages.querySelectorAll('.message.streaming').forEach(el => el.remove());

          const html = this.formatMessageText(completedText);
          const { textHtml, iframes } = this.extractIframes(html);

          const messageDiv = document.createElement('div');
          messageDiv.className = 'message bot-message finalized';
          messageDiv.innerHTML = `
            <div class="message-content">
              <div class="message-bubble">${textHtml}</div>
              ${this.createMessageActions()}
              ${suggestions.length > 0 ? this.createSuggestionChips(suggestions) : ''}
              <span class="message-time">${timeStr}</span>
            </div>`;

          if (iframes.length) {
            const contentDiv = messageDiv.querySelector('.message-content');
            const insertBefore = contentDiv.querySelector('.suggestion-chips') || contentDiv.querySelector('.message-time');
            iframes.forEach(iframe => {
              iframe.className = 'message-iframe';
              if (insertBefore) contentDiv.insertBefore(iframe, insertBefore);
              else contentDiv.appendChild(iframe);
            });
          }

          this.elements.messages.appendChild(messageDiv);
          this.scrollToBottom();
        };

        const onClarification = (questions) => {
          this.hideTypingIndicator();
          this.addClarificationMessage(questions, message);
        };

        const shouldThink = this.elements.thinkingToggle ? this.elements.thinkingToggle.checked : false;
        await this.api.sendMessage(message, this.sessionId, shouldThink, onChunk, onComplete, onClarification);
        this.hideTypingIndicator();
      } catch (error) {
        this.hideTypingIndicator();
        this.addMessage(fallbackResponse || this.config.messages.errorGeneric, 'bot');
        console.error('[Widget] Error sending message:', error);
    } finally {
      this.isSending = false;
    }
  }
  addMessage(text, sender, options = null) {
    const now = new Date();
    const timeStr = now.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
    if (sender === 'bot') {
      const { text: textWithoutChips, chips } = this.extractSuggestionChips(text);
      const html = this.formatMessageText(textWithoutChips || text);
      const { textHtml: bubbleHtml, iframes } = this.extractIframes(html);

      const messageDiv = document.createElement('div');
      messageDiv.className = 'message bot-message';
      messageDiv.innerHTML = `
        <div class="message-content">
          <div class="message-bubble">${bubbleHtml}${options ? this.createOptions(options) : ''}</div>
          ${this.createMessageActions()}
          ${chips.length > 0 ? this.createSuggestionChips(chips) : ''}
          <span class="message-time">${timeStr}</span>
        </div>`;

      if (iframes.length) {
        const contentDiv = messageDiv.querySelector('.message-content');
        const insertBefore = contentDiv.querySelector('.suggestion-chips') || contentDiv.querySelector('.message-time');
        iframes.forEach(iframe => {
          iframe.className = 'message-iframe';
          if (insertBefore) contentDiv.insertBefore(iframe, insertBefore);
          else contentDiv.appendChild(iframe);
        });
      }
      this.elements.messages.appendChild(messageDiv);
    } else {
      const messageDiv = document.createElement('div');
      messageDiv.className = 'message user-message';
      // Create elements safely without innerHTML to prevent XSS
      const contentDiv = document.createElement('div');
      contentDiv.className = 'message-content';
      const bubbleDiv = document.createElement('div');
      bubbleDiv.className = 'message-bubble';
      bubbleDiv.textContent = text;  // Use textContent for user input (safe)
      const timeSpan = document.createElement('span');
      timeSpan.className = 'message-time';
      timeSpan.textContent = timeStr;
      contentDiv.appendChild(bubbleDiv);
      contentDiv.appendChild(timeSpan);
      messageDiv.appendChild(contentDiv);
      this.elements.messages.appendChild(messageDiv);
    }
    this.scrollToBottom();
  }
  extractSuggestionChips(text) {
    const chips = [];
    const chipRegex = /\[([^\]]+)\]\(query:([^)]+)\)/g;
    let match;
    while ((match = chipRegex.exec(text)) !== null) {
      chips.push({
        text: match[1],
        query: match[2]
      });
    }

    const lines = text.split('\n');
    const filteredLines = lines.filter(line => {
      const trimmed = line.trim();
      const listItemWithOnlyChip = /^[\s]*(\d+\.|\*|\-|\+)[\s]*\[([^\]]+)\]\(query:([^)]+)\)[\s]*$/.test(trimmed);
      if (listItemWithOnlyChip) {
        return false;
      }
      return true;
    });

    const textWithoutChips = filteredLines.join('\n').replace(/\[([^\]]+)\]\(query:([^)]+)\)/g, '').trim();

    return { text: textWithoutChips || '', chips };
  }
  formatMessageText(text) {
    if (!text || typeof text !== 'string') return '';
    // Strip "Open in Google Maps" links the LLM may still generate
    text = text.replace(/\[Open in Google Maps\]\([^)]*\)\s*/gi, '');
    return marked.parse(text);
  }
  extractIframes(html) {
    const tmp = document.createElement('div');
    tmp.innerHTML = html;
    const iframes = [...tmp.querySelectorAll('iframe')];
    iframes.forEach(iframe => iframe.remove());
    return { textHtml: tmp.innerHTML, iframes };
  }
  splitIntoBubbles(html) {
    // Split rendered HTML at heading boundaries (<h3>, <h4>)
    // No headings → single bubble; headings → each section is a bubble
    const parts = html.split(/(?=<h[34][\s>])/);
    return parts.map(p => p.trim()).filter(p => p);
  }
  createMessageActions() {
    return `<div class="message-actions">
      <button class="message-action-btn" data-action="copy" title="Copy">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
      </button>
      <button class="message-action-btn" data-action="thumbup" title="Good response">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M7 10v12"/><path d="M15 5.88 14 10h5.83a2 2 0 0 1 1.92 2.56l-2.33 8A2 2 0 0 1 17.5 22H4a2 2 0 0 1-2-2v-8a2 2 0 0 1 2-2h2.76a2 2 0 0 0 1.79-1.11L12 2a3.13 3.13 0 0 1 3 3.88Z"/></svg>
      </button>
      <button class="message-action-btn" data-action="thumbdown" title="Bad response">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 14V2"/><path d="M9 18.12 10 14H4.17a2 2 0 0 1-1.92-2.56l2.33-8A2 2 0 0 1 6.5 2H20a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2h-2.76a2 2 0 0 0-1.79 1.11L12 22a3.13 3.13 0 0 1-3-3.88Z"/></svg>
      </button>
    </div>`;
  }
  createSuggestionChips(chips) {
    if (!chips || chips.length === 0) return '';
    const escapeHtml = (text) => {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    };
    return `<div class="suggestion-chips">${chips.map(chip => {
      const label = typeof chip === 'string' ? chip : chip.text;
      const query = typeof chip === 'string' ? chip : chip.query;
      return `<a href="#" class="suggestion-chip" data-query="${escapeHtml(query)}">↳&nbsp;${escapeHtml(label)}</a>`;
    }).join('')}</div>`;
  }
  createOptions(options) {
    if (options.type === 'times') {
      return `<div class="time-slots">${options.values.map(time => `<button class="time-slot" data-time="${time}">${time}</button>`).join('')}</div>`;
    } else if (options.type === 'restaurants') {
      return `<div class="restaurant-options">${options.values.map(restaurant => `<button class="restaurant-option" data-restaurant="${restaurant}">${restaurant}</button>`).join('')}</div>`;
    }
    return '';
  }
  addClarificationMessage(questions, originalQuery) {
    if (!questions || !questions.length) return;
    const q = questions[0];
    const escapeHtml = (t) => {
      const d = document.createElement('div');
      d.textContent = t;
      return d.innerHTML;
    };
    const timeStr = new Date().toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
    const messageDiv = document.createElement('div');
    messageDiv.className = 'message bot-message';
    const optionsHtml = q.options.map(opt =>
      `<button class="clarification-option" data-query="${escapeHtml(originalQuery)} — ${escapeHtml(opt)}">${escapeHtml(opt)}</button>`
    ).join('');
    messageDiv.innerHTML = `
      <div class="message-avatar">${this.config.branding.getLogo()}</div>
      <div class="message-content">
        <div class="message-bubble">${escapeHtml(q.question)}</div>
        <div class="clarification-options">${optionsHtml}</div>
        <span class="message-time">${timeStr}</span>
      </div>
    `;
    this.elements.messages.appendChild(messageDiv);
    this.scrollToBottom();
  }
  async handleOptionClick(e) {
    const actionBtn = e.target.closest('.message-action-btn');
    if (actionBtn) {
      e.preventDefault();
      const action = actionBtn.dataset.action;
      const messageDiv = actionBtn.closest('.bot-message');
      const bubble = messageDiv?.querySelector('.message-bubble');
      if (action === 'copy' && bubble) {
        navigator.clipboard.writeText(bubble.innerText).then(() => {
          actionBtn.classList.add('copied');
          const origSvg = actionBtn.innerHTML;
          actionBtn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 6 9 17l-5-5"/></svg>';
          setTimeout(() => { actionBtn.classList.remove('copied'); actionBtn.innerHTML = origSvg; }, 1500);
        });
      } else if (action === 'thumbup' || action === 'thumbdown') {
        const opposite = action === 'thumbup' ? 'thumbdown' : 'thumbup';
        const oppositeBtn = messageDiv?.querySelector(`[data-action="${opposite}"]`);
        if (actionBtn.classList.contains('active')) {
          actionBtn.classList.remove('active');
        } else {
          actionBtn.classList.add('active');
          oppositeBtn?.classList.remove('active');
        }
      }
      return;
    }
    if (e.target.classList.contains('clarification-option')) {
      e.preventDefault();
      const query = e.target.dataset.query;
      if (query) {
        const optionsDiv = e.target.closest('.clarification-options');
        if (optionsDiv) optionsDiv.querySelectorAll('button').forEach(b => b.disabled = true);
        this.addMessage(query, 'user');
        await this.sendMessageToBackend(query);
      }
      return;
    }
    if (e.target.classList.contains('suggestion-chip')) {
      e.preventDefault();
      const query = e.target.dataset.query;
      if (query) {
        // Only remove the chips container that contains the clicked chip
        const chipContainer = e.target.closest('.suggestion-chips');
        if (chipContainer) chipContainer.remove();

        this.addMessage(query, 'user');
        await this.sendMessageToBackend(query);
      }
      return;
    }

    if (e.target.classList.contains('time-slot')) {
      const time = e.target.dataset.time;
      this.addMessage(`${time} would be perfect!`, 'user');
      const fallback = `Excellent choice! I've noted ${time} for your reservation. Could you provide your name and contact number to confirm?`;
      await this.sendMessageToBackend(`I'd like to book for ${time}`, fallback);
    }
    if (e.target.classList.contains('restaurant-option')) {
      const restaurant = e.target.dataset.restaurant;
      this.addMessage(`I'd like to book at ${restaurant}`, 'user');
      const fallback = `Great choice! ${restaurant} is wonderful. How many guests will be joining you?`;
      await this.sendMessageToBackend(`I'd like to book at ${restaurant}`, fallback);
    }
  }
  showTypingIndicator() {
    if (!this.elements.messages) return;
    const typingDiv = document.createElement('div');
    typingDiv.className = 'message bot-message';
    typingDiv.id = 'typingIndicator';
    typingDiv.innerHTML = `<div class="message-avatar">${this.config.branding.getLogo()}</div><div class="message-content"><div class="typing-indicator"><span></span><span></span><span></span></div><span class="typing-label">Concy is typing...</span></div>`;
    this.elements.messages.appendChild(typingDiv);
    this.scrollToBottom();
  }
  hideTypingIndicator() {
    const indicator = document.getElementById('typingIndicator');
    if (indicator) indicator.remove();
  }
  scrollToBottom() {
    if (this.elements.messages && this.elements.messages.scrollHeight) {
      this.elements.messages.scrollTop = this.elements.messages.scrollHeight;
    }
  }
}

// Initialize widget
document.addEventListener('DOMContentLoaded', function() {
  window.concyWidget = new ConcyWidget(CONCY_CONFIG);
});
    </script>
</body>
</html>
